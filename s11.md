#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>


struct Libro {
    int id;
    char titulo[101];
    char autor[51];
    int anio;
    char estado[20];
};


int idExiste(struct Libro libros[], int num_libros, int id) {
    for (int i = 0; i < num_libros; i++) {
        if (libros[i].id == id) {
            return 1; 
        }
    }
    return 0; 
}


int validarCadena(char *cadena, int max_len) {
    if (strlen(cadena) == 0 || strlen(cadena) > max_len) {
        return 0; 
    }
    return 1; 
}


int validarAnio(int anio) {
    if (anio < 0 || anio > 2023) {
        return 0; 
    }
    return 1; 
}


int validarEstado(char *estado) {
    if (strcmp(estado, "Disponible") == 0 || strcmp(estado, "Prestado") == 0) {
        return 1; 
    }
    return 0; 
}


void agregarLibro(struct Libro libros[], int *num_libros) {
    if (*num_libros >= 10) {
        printf("No se pueden agregar más de 10 libros.\n");
        return;
    }

    struct Libro nuevo;
    char buffer[256];

    
    printf("Ingrese ID del libro (entero único): ");
    if (scanf("%d", &nuevo.id) != 1 || nuevo.id <= 0 || idExiste(libros, *num_libros, nuevo.id)) {
        printf("ID inválido o ya existe.\n");
        while (getchar() != '\n'); 
        return;
    }
    while (getchar() != '\n'); 

    
    printf("Ingrese título (hasta 100 caracteres): ");
    fgets(nuevo.titulo, sizeof(nuevo.titulo), stdin);
    nuevo.titulo[strcspn(nuevo.titulo, "\n")] = '\0'; 
    if (!validarCadena(nuevo.titulo, 100)) {
        printf("Título inválido.\n");
        return;
    }

    
    printf("Ingrese autor (hasta 50 caracteres): ");
    fgets(nuevo.autor, sizeof(nuevo.autor), stdin);
    nuevo.autor[strcspn(nuevo.autor, "\n")] = '\0'; 
    if (!validarCadena(nuevo.autor, 50)) {
        printf("Autor inválido.\n");
        return;
    }

    
    printf("Ingrese año de publicación: ");
    if (scanf("%d", &nuevo.anio) != 1 || !validarAnio(nuevo.anio)) {
        printf("Año inválido.\n");
        while (getchar() != '\n'); 
        return;
    }
    while (getchar() != '\n'); 

    
    printf("Ingrese estado (Disponible o Prestado): ");
    fgets(nuevo.estado, sizeof(nuevo.estado), stdin);
    nuevo.estado[strcspn(nuevo.estado, "\n")] = '\0'; 
    if (!validarEstado(nuevo.estado)) {
        printf("Estado inválido.\n");
        return;
    }

    
    libros[*num_libros] = nuevo;
    (*num_libros)++;
    printf("Libro agregado exitosamente.\n");
}


void mostrarLibros(struct Libro libros[], int num_libros) {
    if (num_libros == 0) {
        printf("No hay libros registrados.\n");
        return;
    }

    printf("%-5s %-30s %-20s %-10s %-15s\n", "ID", "Título", "Autor", "Año", "Estado");
    printf("--------------------------------------------------------------------------------\n");
    for (int i = 0; i < num_libros; i++) {
        printf("%-5d %-30s %-20s %-10d %-15s\n", libros[i].id, libros[i].titulo, libros[i].autor, libros[i].anio, libros[i].estado);
    }
}


void buscarLibro(struct Libro libros[], int num_libros) {
    int opcion;
    printf("Buscar por: 1. ID  2. Título\n");
    printf("Opción: ");
    scanf("%d", &opcion);
    while (getchar() != '\n'); 

    if (opcion == 1) {
        int id;
        printf("Ingrese ID: ");
        scanf("%d", &id);
        while (getchar() != '\n'); 
        for (int i = 0; i < num_libros; i++) {
            if (libros[i].id == id) {
                printf("ID: %d\nTítulo: %s\nAutor: %s\nAño: %d\nEstado: %s\n", libros[i].id, libros[i].titulo, libros[i].autor, libros[i].anio, libros[i].estado);
                return;
            }
        }
        printf("Libro no encontrado.\n");
    } else if (opcion == 2) {
        char titulo[101];
        printf("Ingrese título: ");
        fgets(titulo, sizeof(titulo), stdin);
        titulo[strcspn(titulo, "\n")] = '\0';
        for (int i = 0; i < num_libros; i++) {
            if (strcmp(libros[i].titulo, titulo) == 0) {
                printf("ID: %d\nTítulo: %s\nAutor: %s\nAño: %d\nEstado: %s\n", libros[i].id, libros[i].titulo, libros[i].autor, libros[i].anio, libros[i].estado);
                return;
            }
        }
        printf("Libro no encontrado.\n");
    } else {
        printf("Opción inválida.\n");
    }
}


void actualizarEstado(struct Libro libros[], int num_libros) {
    int id;
    printf("Ingrese ID del libro a actualizar: ");
    scanf("%d", &id);
    while (getchar() != '\n'); 

    for (int i = 0; i < num_libros; i++) {
        if (libros[i].id == id) {
            char nuevo_estado[20];
            printf("Estado actual: %s\n", libros[i].estado);
            printf("Ingrese nuevo estado (Disponible o Prestado): ");
            fgets(nuevo_estado, sizeof(nuevo_estado), stdin);
            nuevo_estado[strcspn(nuevo_estado, "\n")] = '\0';
            if (validarEstado(nuevo_estado)) {
                strcpy(libros[i].estado, nuevo_estado);
                printf("Estado actualizado.\n");
            } else {
                printf("Estado inválido.\n");
            }
            return;
        }
    }
    printf("Libro no encontrado.\n");
}


void eliminarLibro(struct Libro libros[], int *num_libros) {
    int id;
    printf("Ingrese ID del libro a eliminar: ");
    scanf("%d", &id);
    while (getchar() != '\n'); 

    for (int i = 0; i < *num_libros; i++) {
        if (libros[i].id == id) {
            // Desplazar elementos
            for (int j = i; j < *num_libros - 1; j++) {
                libros[j] = libros[j + 1];
            }
            (*num_libros)--;
            printf("Libro eliminado.\n");
            return;
        }
    }
    printf("Libro no encontrado.\n");
}


int main() {
    struct Libro libros[10];
    int num_libros = 0;
    int opcion;

    do {
        printf("\n--- Gestión de Biblioteca ---\n");
        printf("1. Agregar libro\n");
        printf("2. Mostrar libros\n");
        printf("3. Buscar libro\n");
        printf("4. Actualizar estado\n");
        printf("5. Eliminar libro\n");
        printf("6. Salir\n");
        printf("Opción: ");
        scanf("%d", &opcion);
        while (getchar() != '\n'); // Limpiar buffer

        switch (opcion) {
            case 1:
                agregarLibro(libros, &num_libros);
                break;
            case 2:
                mostrarLibros(libros, num_libros);
                break;
            case 3:
                buscarLibro(libros, num_libros);
                break;
            case 4:
                actualizarEstado(libros, num_libros);
                break;
            case 5:
                eliminarLibro(libros, &num_libros);
                break;
            case 6:
                printf("Saliendo...\n");
                break;
            default:
                printf("Opción inválida.\n");
        }
    } while (opcion != 6);

    return 0;
}
